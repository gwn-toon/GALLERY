<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GALLERY</title>

  <link href="https://fonts.cdnfonts.com/css/ocr-a-extended" rel="stylesheet">
  <style>
  :root {
    --gap: 24px;
    --black-bar-height: 14px;
    --img-w: 2560;
    --img-h: 1780;
    --aspect-ratio: calc(var(--img-w) / var(--img-h));
  }

  /* =========================================
      GLOBAL
  ========================================= */
  body {
    margin: 0;  
    background: #e7e8e9;
    overflow: hidden;
  }

  .app {
    display: flex;
    height: 100vh;
    width: 100vw;
    overflow: hidden;
  }

  /* =========================================
      LEFT AUTOSCROLL COLUMN
  ========================================= */
  .gallery-scroll {
    width: 50%;
    height: 100%;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    padding: 24px;
    margin-top: 24px;
    position: relative;
  }

  #scroll-track {
    display: flex;
    flex-direction: column;
    gap: var(--gap);
  }

  #scroll-content,
  #scroll-duplicate {
    display: flex;
    flex-direction: column;
    gap: var(--gap);
    pointer-events: none;
  }

/* =========================================
    MIDDLE DIVIDER
========================================= */
.divider {
  width: 14px;
  background: black;
  margin-top: 24px;
  margin-bottom: 24px;
}

/* =========================================
    RIGHT GALLERY GRID
========================================= */
.gallery-wrap {
  width: 50%;
  height: 100%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

#gallery {
  overflow-y: scroll;
  padding: var(--gap);
  padding-top: 0px;
  display: grid;
  gap: var(--gap);
  grid-template-columns: repeat(2, 1fr);
}

@media (min-height: 780px){
  .gallery-wrap{
    height: 91%;
  }

  #fullscreen-viewer{
    margin-top: 50px;
  }

  #fullscreen-viewer img{
    max-height: 78vh !important;
  }

  #qr-wrap img {
    width: min(80vw, 450px) !important;
  }
}

@media (min-height: 900px) {
  .gallery-wrap{
    height: 92%;
  }

  #fullscreen-viewer{
    margin-top: 50px;
  }

  #fullscreen-viewer img{
    max-height: 81vh !important;
  }

  #qr-wrap img {
    width: min(80vw, 500px) !important;
  }

  }

/* =========================================
    IMAGE BOX DESIGN
========================================= */
.box-wrapper {
  transition: transform 0.02s ease;
  transform-origin: center;
}

.display-box {
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: white;
  position: relative;
}

.display-box::after {
  content: "";
  position: absolute;
  inset: 0;
  border: 14px solid black;
  opacity: 0;
  pointer-events: none;
}

.box-wrapper:hover .display-box::after {
  opacity: 1;
}

.black-bar {
  height: var(--black-bar-height);
  width: 100%;
  background: black;
}

.image-container {
  width: 100%;
  aspect-ratio: var(--aspect-ratio);
  background: white;
  overflow: hidden;
  position: relative;
}

.image-container img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.number-overlay {
  position: absolute;
  top: 48%;
  left: 50%;
  transform: translate(-50%, -50%);

  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;

  opacity: 0;
  pointer-events: none;
}


.overlay-number {
  font-family: "OCR A Extended", monospace;
  font-size: 80px;
  letter-spacing: -3px;
  line-height: 1;
  flex-shrink: 0;

}

.overlay-prompt {
  font-family: "OCR A Extended", monospace;
  font-size: 40px;
  letter-spacing: -3px;
  line-height: 1.1;
  margin-top: -13px;
  opacity: 1;

}



.box-wrapper:hover .number-overlay {
  opacity: 1;
}

/* SORT BAR */
#sort-bar {
  display: flex;
  align-items: center;
  gap: 14px;
  margin-left: var(--gap);
  margin-top: var(--gap);
  margin-bottom: 24px;
}

#sort-bar .text-box {
  cursor: pointer;
  padding: 4px 12px;
  font-size: 28px;
  letter-spacing: -3px;
  font-family: "OCR A Extended", monospace;
  background-color: white;
  border-left: 14px solid black;
  border-right: 14px solid black;
}

#sort-bar .text-box:hover {
  cursor: pointer;
  background-color: blue;
  color: white;
}

#sort-options .sort-item {
  cursor: pointer;
  padding: 4px 12px;
  font-size: 28px;
  letter-spacing: -3px;
  font-family: "OCR A Extended", monospace;
  background-color: white;
  border-left: 14px solid black;
  border-right: 14px solid black;
}

#sort-options .sort-item:hover {
  cursor: pointer;
  background-color: blue;
  color: white;
}

/* SORT OPTIONS GRID */
#sort-options {
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-start;   /* left aligned */
  gap: 14px;
  padding: var(--gap);
  padding-top: 0px;
}

#sort-options.hidden {
  display: none;
}

.sort-current.text-box{
  pointer-events: none;
}

.gallery-arrow {
  width: 50px;
  height: 30px;
  display: flex;
  justify-content: center;
  align-items: center;

}


/* =========================================
    FULLSCREEN VIEWER
========================================= */
#fullscreen-viewer {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;

  display: none;
  z-index: 9999;

  justify-content: center;
  align-items: center;
}


#fullscreen-viewer img {
  max-width: 92vw;
  max-height: 87vh;
  object-fit: contain;
  border-left: 14px solid black;
  border-right: 14px solid black;
  display: block;
}

#fs-img-wrap {
  position: relative;
  display: inline-block; /* shrinkwrap to image size */
  margin: 0;
}

.fs-close {
  position: absolute;
  top: 0;
  right: 14px;
  width: 50px;
  height: 50px;
  background: white;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  z-index: 10;
  border-left: var(--black-bar-height) solid black;
  color: red;
}

.fs-close svg {
  width: 32px;
  height: 32px;
}

.fs-close:hover{
  background: red;
  color: white;
}

#qr-close{
  margin-right: -14px;
}
    /* ===================== QR FULLSCREEN ===================== */

#qr-viewer {
  position: fixed;
  inset: 0;
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 10000;
  margin-top: 98px
}

#qr-panel {
  display: flex;
  flex-direction: column;   /* THIS is the key */
  gap: 14px;
  align-items: center;
}

#qr-wrap {
  position: relative;
  background: white;
  padding: 30px;
  border-left: 14px solid black;
  border-right: 14px solid black;
}


#qr-wrap img {
  width: min(80vw, 630px);
  height: auto;
  display: block;
}

/* QR button hover */
.qr-button {
  cursor: pointer;
  border-left: none;
}

.qr-button:hover {
  background: blue;
  color: white;
}

    /* ===================== GALLERY TOP BAR ===================== */

.gallery-topbar {
    display: none;              /* hidden by default */
    height: 50px;
    margin: 24px;
    margin-bottom: 0;

    display: grid;
    grid-template-columns: auto 1fr auto;
    column-gap: 0;
}

/* Generic item box */
.gallery-top-item {
    background: white;
    border-left: 14px solid black;
    border-right: 14px solid black;

    display: flex;
    align-items: center;
    justify-content: center;

    font-family: "OCR A Extended", monospace;
    font-size: 28px;
    letter-spacing: -3px;
    padding-left: 15px;
    padding-right: 15px;
}

#drawingCountBox .bracket-left,
#drawingCountBox .bracket-right {
    color: red;
    font-weight: bold;
}

#drawingCountNumber {
    display: inline-block;
    width: 40px;  /* keeps number from shifting layout */
    text-align: center;
    color: red;
}

/* REUSE YOUR EXISTING SCROLLER CSS EXACTLY */
.gallery-top-item.scroller {
    position: relative;
    overflow: visible;
    min-width: 0;
    padding-left: 19px;
    padding-right: 19px;
    display: flex;
    align-items: center;
    border: none;
}

.gallery-top-item.scroller .mask {
    overflow: hidden;
    white-space: nowrap;
    position: relative;
}

.gallery-top-item.scroller .scroll-track {
    display: inline-flex;
    white-space: nowrap;
    animation: scroll-left 25s linear infinite;
}

.scroll-text {
    font-family: "OCR A Extended", monospace;
    font-size: 28px;
    letter-spacing: -3px;
    white-space: nowrap;
    padding-right: 0;
}


@keyframes scroll-left {
    0%   { transform: translateX(0); }
    100% { transform: translateX(-50%); }
}

/* Hide the topbar ONLY during normal mobile browsing, not fullscreen */
@media (max-height: 780px) {
  .gallery-topbar {
      display: none;
  }
}

@media (max-width: 1290px) {
  #gallery{
    grid-template-columns: repeat(1, 1fr);
   
  }
}


@media (max-width: 804px) {
  /* ---- LAYOUT RESET FOR PHONE ---- */
  body {
    overflow: auto;
  }

  .app {
    flex-direction: column;
    height: auto;
    overflow: visible;
  }

  /* hide desktop-only parts */
  .gallery-scroll,
  .divider {
    display: none;
  }

  /* gallery takes full width */
  .gallery-wrap {
    width: 100%;
    height: auto;
    overflow: visible;
  }

  /* let the page (body) scroll, not #gallery */
  #gallery {
    grid-template-columns: 1fr;
    padding: 24px;
    padding-top: 0px;
    overflow-y: visible;        /* ⬅ override desktop scroll */
  }

  /* no hover overlay on mobile */
  .display-box::after {
    opacity: 0;
  }

  .number-overlay {
    display: none;
  }

  /* ---- SORT BAR: DESKTOP STYLE + STICKY ---- */
  #sort-bar {
  position: sticky;
  top: 0;
  left: 0;
  right: 0;

  z-index: 100;
  background: #e7e8e9;

  margin: 0;
  padding: 24px 24px;

  display: flex;
  align-items: center;
  gap: 14px;
}

#sort-options {
    position: sticky;
    top: calc(24px * 2 + 37px); /* below sort bar */
    left: 0;
    right: 0;

    z-index: 150;
    background: #e7e8e9;
  }

/* ✅ THIS LINE IS CRITICAL */


  /* undo the “line-break” hack from the 780px media query */
  #sort-bar::after {
    content: none;
    display: none;
  }

  /* order = SORT, arrow, ALL (current) */
  .sort-button {
    order: 1;
    margin: 0;
  }

  .gallery-arrow {
    order: 2;
    display: flex;   /* ⬅ override .gallery-arrow{display:none !important;} */
  }

  .sort-current {
    order: 3;
    width: auto;
    margin: 0;
  }

  /* ---- FULLSCREEN IMAGE: slightly narrower on phone ---- */
  #fullscreen-viewer img {
    max-width: 85vw !important;
  }

  /* ---- MOBILE DOWNLOAD ROW UNDER IMAGE ---- */

  /* black border also when active (tap) on mobile */
  .box-wrapper:hover .display-box::after,
  .box-wrapper.active .display-box::after {
    opacity: 1;
  }

  /* hidden by default */
  .mobile-row {
    display: none;
    margin-top: 24px;          /* gap from image */
    gap: 24px;                 /* gap between the two strips */
  }

  /* show when this box is active */
  .box-wrapper.active .mobile-row {
    display: flex;
  }

  /* shared strip styling */
  .mobile-strip {
    background: white;
    border-left: 14px solid black;
    border-right: 14px solid black;
    padding: 4px 12px;
    font-family: "OCR A Extended", monospace;
    font-size: 28px;
    letter-spacing: -3px;
    display: flex;
    align-items: center;
    white-space: nowrap;
  }

  /* left box = DOWNLOAD */
  .mobile-download {
    justify-content: flex-start;
  }

  .mobile-download:hover {
    background: blue;
    color: white;
    cursor: pointer;
  }

  /* right box = number + prompt */
  .mobile-meta {
    justify-content: flex-end;
    text-align: right;
    margin-left: auto;
    pointer-events: none;
  }
}

/* default (desktop) */
.mobile-row {
  display: none;
}

.mobile-hint-bar{
  display: none;
}

@media (max-width: 490px){
  body {
    -webkit-user-select: none;
    user-select: none;
  }
  
 .display-box::after {
    opacity: 0;
  }

  .mobile-meta{
    display: none;
  }

  .gallery-topbar{
    display: none;
  }

  .mobile-hint-bar {
    position: sticky;
    top: 24px;
    z-index: 200;

    height: 37px;
    background: white;
    margin: 0 24px;

    border-left: 14px solid black;
    border-right: 14px solid black;

    overflow: hidden;
    display: flex;
    align-items: center;
  }

  .mobile-hint-mask {
    overflow: hidden;
    white-space: nowrap;
    width: 100%;
    margin-left: 14px;
    margin-right: 14px;
  }

  .mobile-hint-track {
    display: inline-flex;
    width: max-content;
    flex-shrink: 0;

    animation: mobile-scroll 10s linear infinite;
  }

  .mobile-scroll-text {
    font-family: "OCR A Extended", monospace;
    font-size: 28px;
    letter-spacing: -3px;
    white-space: nowrap;
  }

  .tap{
    color: red;
  }

  #sort-bar{
    top: 61px;
  }

  #sort-options{
    top: calc(24px * 2 + 98px);
  }

  @keyframes mobile-scroll {
    0%   { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }
}
  </style>
</head>

<body>
  <div class="mobile-hint-bar">
    <div class="mobile-hint-mask">
      <div class="mobile-hint-track">
        <span class="mobile-scroll-text">
          &nbsp;<span class="tap">TAP</span> + <span class="tap">HOLD</span> TO SAVE — <span class="tap">TAP</span> + <span class="tap">HOLD</span> TO SAVE —
        </span>
        <span class="mobile-scroll-text">
          &nbsp;<span class="tap">TAP</span> + <span class="tap">HOLD</span> TO SAVE — <span class="tap">TAP</span> + <span class="tap">HOLD</span> TO SAVE —
        </span>
      </div>
    </div>
  </div>
<!-- ===================== GALLERY TOP BAR (fullscreen only) ===================== -->
<div id="gallery-topbar" class="gallery-topbar">
    <!-- LEFT SECTION -->
    <div class="gallery-top-item" id="gallery-left">
        <div class="topbar-item" id="drawingCountBox">
            DRAWINGS MADE: 
            <span class="bracket-left">&lt;</span>
            <span id="drawingCountNumber">000</span>
            <span class="bracket-right">&gt;</span>
        </div>
    </div>

    <!-- MIDDLE SCROLLER (IDENTICAL TO TOOLKIT) -->
    <div class="gallery-top-item scroller">
        <div class="mask">
            <div class="scroll-track">
                <span class="scroll-text">
                    &nbsp;VIEW MACHINE - VIEW MACHINE - VIEW MACHINE -
                    VIEW MACHINE - VIEW MACHINE - VIEW MACHINE - VIEW MACHINE - VIEW MACHINE -
                    VIEW MACHINE - VIEW MACHINE -
                </span>
                <span class="scroll-text">
                    &nbsp;VIEW MACHINE - VIEW MACHINE - VIEW MACHINE -
                    VIEW MACHINE - VIEW MACHINE - VIEW MACHINE - VIEW MACHINE - VIEW MACHINE -
                    VIEW MACHINE - VIEW MACHINE -
                </span>
            </div>
        </div>
    </div>

    <!-- RIGHT SECTION -->
    <div class="gallery-top-item qr-button" id="qr-open">
      DOWNLOAD DRAWINGS
    </div>
</div>

<!-- ===================== GALLERY  ===================== -->
<div id="fullscreen-viewer">
  <div id="fs-img-wrap">
    <img id="fullscreen-img">
    <div id="fs-close" class="fs-close">
      <!-- your cross SVG will go here -->
      <svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
        <path d="M2 2 L18 18 M2 18 L18 2" 
             stroke="currentColor" stroke-width="4" fill="none"/>
      </svg>
    </div>
  </div>
</div>

<div id="qr-viewer">
  <div id="qr-panel">
  <div id="qr-wrap">
    <img src="frame.png" alt="Gallery QR code">
    <div id="qr-close" class="fs-close">
      <!-- your cross SVG will go here -->
      <svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
        <path d="M2 2 L18 18 M2 18 L18 2" 
             stroke="currentColor" stroke-width="4" fill="none"/>
      </svg>
    </div> 
  </div>
  </div> 
</div>

<div class="app">
  <!-- LEFT AUTO SCROLL COLUMN -->
  <div class="gallery-scroll">
    <div id="scroll-track">
      <div id="scroll-content"></div>
      <div id="scroll-duplicate"></div>
    </div>
  </div>

  <div class="divider"></div>

  <!-- RIGHT CLICKABLE GALLERY -->
  <div class="gallery-wrap">
    <div id="sort-bar">
      <div class="sort-button text-box">SORT</div>
      <div class="gallery-arrow">
        <svg xmlns="http://www.w3.org/2000/svg" width="200%" height="200%"
        viewBox="0 0 20 20" preserveAspectRatio="xMidYMid meet">
          <!-- rotated line -->
          <line x1="5" y1="10" x2="12" y2="10"
                stroke="#000" stroke-width="2" stroke-linecap="square"/>
        
          <!-- rotated arrowhead -->
          <polyline points="10,14 14,10 10,6"
                    fill="none" stroke="#000" stroke-width="2" stroke-linecap="square"/>
        </svg>

      </div>      
      <div class="sort-current text-box">ALL</div>
    </div>
    
    <div id="sort-options" class="hidden"></div>
    
    <div id="gallery"></div>
  </div>
</div>

<script type="module">
  const WORKER_BASE_URL =
    "https://toolkit-uploader.toolkit-toontoolkit-toon.workers.dev";

  let imageList = [];
  let galleryImages = [];
  let scrollImages  = [];

  function updateDrawingCount(count) {
    const formatted = String(count).padStart(3, "0");
    document.getElementById("drawingCountNumber").textContent = formatted;
}

function isMobile() {
  // same breakpoint as your CSS mobile layout
  return window.matchMedia("(max-width: 804px)").matches;
}


  // SORT SYSTEM
  let allPrompts = new Set();
  let currentPromptFilter = "ALL";

  async function fetchGalleryList() {
    const res = await fetch(`${WORKER_BASE_URL}/list`);
    if (!res.ok) {
      console.error("Failed to fetch list:", await res.text());
      return [];
    }
    const data = await res.json();

    return data
      .filter(item => item.url)
      .sort((a, b) => new Date(a.uploaded) - new Date(b.uploaded));
  }

  function createBox(url, numberText, prompt) {
  const wrapper = document.createElement("div");
  wrapper.classList.add("box-wrapper");

  wrapper.innerHTML = `
    <div class="display-box">
      <div class="black-bar"></div>
      <div class="image-container">
        <img src="${url}">
        <div class="number-overlay">
          <div class="overlay-number">${numberText}</div>
          <div class="overlay-prompt">&lt;${prompt}&gt;</div>
        </div>
      </div>
    </div>

    <!-- MOBILE-ONLY INFO STRIP -->
    <div class="mobile-row">
      <div class="mobile-strip mobile-download">
        DOWNLOAD
      </div>

      <div class="mobile-strip mobile-meta">
        ${numberText} &lt;${prompt}&gt;
      </div>
    </div>
  `;

  const downloadBtn = wrapper.querySelector(".mobile-download");
const img = wrapper.querySelector("img");

  if (downloadBtn) {
    downloadBtn.addEventListener("click", (e) => {
      e.stopPropagation(); // important: don’t toggle active state
      downloadImage(
        img.src,
        `${numberText}-${prompt}.png`
      );
    });
  }

  return {
    wrapper,
    img: wrapper.querySelector("img")
  };
}



function renumberRight() {
  const overlays = document.querySelectorAll("#gallery .number-overlay");
  const total = overlays.length;

  overlays.forEach((overlay, index) => {
    const number = String(total - index).padStart(3, "0");
    const numberEl = overlay.querySelector(".overlay-number");
    if (numberEl) numberEl.textContent = number;
  });
}


  async function initialLoad() {
    imageList = await fetchGalleryList();
    updateDrawingCount(imageList.length);

    const gallery = document.getElementById("gallery");
    const scrollContent = document.getElementById("scroll-content");
    const scrollDuplicate = document.getElementById("scroll-duplicate");

    for (let i = imageList.length - 1; i >= 0; i--) {
      const file = imageList[i];
      const url  = file.url;
      const numberText = String(i + 1).padStart(3, "0");

      // Extract prompt
      const prompt = file.key.split("-")[0];
      allPrompts.add(prompt);

      // Right gallery
      
      const { wrapper, img } = createBox(url, numberText, prompt);
      gallery.appendChild(wrapper);
      enableFullscreen(img);
      enableMobileInteraction(wrapper);
      galleryImages.push(img);

      // Left autoscroll
      const { wrapper: scrollBox, img: scrollImg } = createBox(url, numberText, prompt);
      scrollContent.appendChild(scrollBox);
      scrollImages.push(scrollImg);
    }

    scrollDuplicate.innerHTML = scrollContent.innerHTML;


    renderSortOptions();
    renumberRight();
  }

  function rebuildScrollColumn() {
    const scrollContent = document.getElementById("scroll-content");
    const scrollDuplicate = document.getElementById("scroll-duplicate");

    scrollContent.innerHTML = "";

    // newest -> oldest (same as initialLoad)
    for (let i = imageList.length - 1; i >= 0; i--) {
        const file = imageList[i];
        const numberText = String(i + 1).padStart(3, "0");

        const prompt = file.key.split("-")[0].toUpperCase();
        const { wrapper: scrollBox } = createBox(file.url, numberText, prompt);

        scrollContent.appendChild(scrollBox);
    }

    // rebuild the duplicate
    scrollDuplicate.innerHTML = scrollContent.innerHTML;
    }

    async function updateImages() {
  const newList = await fetchGalleryList();

  // If list size changed → image was added or removed
  if (newList.length !== imageList.length) {
    imageList = newList;

    recomputePromptsFromImageList(); // <<< NEW

    filterGallery();
    rebuildScrollColumn();
    updateDrawingCount(imageList.length);

    return;
  }

  // If the same length → check for a NEWEST image only
  const newest = newList[newList.length - 1];
  const lastOld = imageList[imageList.length - 1];

  // If timestamps don’t match → newest image added
  if (newest.uploaded !== lastOld.uploaded) {
    const gallery = document.getElementById("gallery");
    const scrollContent = document.getElementById("scroll-content");

    const numberText = String(newList.length).padStart(3, "0");

    // Right column: prepend
    const prompt = newest.key.split("-")[0].toUpperCase();
    const { wrapper, img } = createBox(newest.url, numberText, prompt);
    gallery.prepend(wrapper);
    enableFullscreen(img);
    enableMobileInteraction(wrapper);

    // Left scroll: prepend
    const { wrapper: scrollBox } = createBox(newest.url, numberText, prompt);
    scrollContent.prepend(scrollBox);

    // Update data
    imageList = newList;

    recomputePromptsFromImageList(); // <<< NEW

    updateDrawingCount(imageList.length);

    return;
  }
}

  // FULLSCREEN
  const viewer    = document.getElementById("fullscreen-viewer");
  const viewerImg = document.getElementById("fullscreen-img");

  function enableFullscreen(img) {
  img.addEventListener("click", (e) => {
    // On mobile: do NOT open fullscreen
    if (isMobile()) {
      return;
    }

    // Desktop behavior: open fullscreen viewer
    viewerImg.src = img.src;
    viewer.style.display = "flex";
  });
}

  viewer.addEventListener("click", () => {
    viewer.style.display = "none";
    viewerImg.src = "";
  });

  document.addEventListener("keydown", e => {
    if (e.key === "Escape") {
      viewer.style.display = "none";
      viewerImg.src = "";
    }
  });

  // AUTOSCROLL LEFT
  let pos = 0;

  function continuousScroll() {
    const track = document.getElementById("scroll-track");
    const content = document.getElementById("scroll-content");

    const GAP = 24;
    const cycleHeight = content.offsetHeight + GAP;

    pos = (pos + 1) % cycleHeight;

    track.style.transform = `translateY(${-pos}px)`;
    requestAnimationFrame(continuousScroll);
  }

  requestAnimationFrame(continuousScroll);

  function enableMobileInteraction(wrapper) {
  wrapper.addEventListener("click", () => {
    if (!isMobile()) return;

    const isActive = wrapper.classList.contains("active");

    document
      .querySelectorAll(".box-wrapper.active")
      .forEach(b => b.classList.remove("active"));

    if (!isActive) {
      wrapper.classList.add("active");
    }
  });
}

   
  // =============================
  // SORT: RENDER OPTIONS
  // =============================
  function displayPromptLabel(prompt) {
      return prompt === "RANDOM" ? "???" : prompt;
    }

  function recomputePromptsFromImageList() {
    allPrompts = new Set();

    imageList.forEach(file => {
      const prompt = file.key.split("-")[0];
      allPrompts.add(prompt);
    });

    // ✅ if current filter no longer exists → reset to ALL
    if (
      currentPromptFilter !== "ALL" &&
      !allPrompts.has(currentPromptFilter)
    ) {
      currentPromptFilter = "ALL";
      document.querySelector(".sort-current").textContent = "ALL";
    }

    renderSortOptions();
  }


  function renderSortOptions() {
    const container = document.getElementById("sort-options");
    container.innerHTML = `
      <div class="text-box sort-item" data-prompt="ALL">ALL</div>
    `;

    [...allPrompts]
      .sort()
      .forEach(prompt => {
      container.innerHTML += `
        <div class="text-box sort-item" data-prompt="${prompt}">
          ${displayPromptLabel(prompt)}
        </div>
      `;
      });

    // Click logic
    container.querySelectorAll(".sort-item").forEach(btn => {
      btn.addEventListener("click", () => {
        currentPromptFilter = btn.dataset.prompt;
        document.querySelector(".sort-current").textContent =
          displayPromptLabel(currentPromptFilter);
        container.classList.add("hidden");
        filterGallery();
      });
    });
  }

  // =============================
  // SORT: FILTER + REBUILD GALLERY
  // =============================
  function filterGallery() {
    const gallery = document.getElementById("gallery");
    gallery.innerHTML = "";

    const filtered = currentPromptFilter === "ALL"
      ? imageList
      : imageList.filter(img => img.key.startsWith(currentPromptFilter + "-"));

    // newest → oldest
    const sorted = filtered.slice().sort(
      (a, b) => new Date(b.uploaded) - new Date(a.uploaded)
    );

    sorted.forEach((file, index) => {
      const numberText = String(index + 1).padStart(3, "0");
      const prompt = file.key.split("-")[0].toUpperCase();
      const { wrapper, img } = createBox(file.url, numberText, prompt);
      gallery.appendChild(wrapper);
      enableFullscreen(img);
      enableMobileInteraction(wrapper);
    });

    renumberRight();
  }

  // SHOW / HIDE SORT DROPDOWN
  document.querySelector(".sort-button").addEventListener("click", () => {
    document.getElementById("sort-options").classList.toggle("hidden");
  });

  // RUN
  await initialLoad();
  setInterval(updateImages, 3000);

  const qrViewer = document.getElementById("qr-viewer");
  const qrOpen = document.getElementById("qr-open");
  const qrClose = document.getElementById("qr-close");

  qrOpen.addEventListener("click", () => {
    qrViewer.style.display = "flex";
  });

  qrClose.addEventListener("click", () => {
    qrViewer.style.display = "none";
  });

  qrViewer.addEventListener("click", (e) => {
    if (e.target === qrViewer) {
      qrViewer.style.display = "none";
    }
  });

   // DOWNLOAD BUTTON
  async function downloadImage(url, filename) {
  try {
    const response = await fetch(url, { mode: "no-cors" });

    const blob = await response.blob();
    const blobURL = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = blobURL;
    a.download = filename;
    document.body.appendChild(a);
    a.click();

    URL.revokeObjectURL(blobURL);
    a.remove();

  } catch (err) {
    console.error("Download failed:", err);
  }
}


</script>


</body>
</html>



